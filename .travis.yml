git:
  submodules: true
  depth: 3

language: cpp

cache:
  directories:
    - ${HOME}/vcpkg/installed

os: osx

addons:
  homebrew:
    packages:
      - cmake
      - gcc@9

matrix:
  allow_failures:
    # /usr/local/Cellar/gcc/9.2.0_2/lib/gcc/9/gcc/x86_64-apple-darwin18/9.2.0/include-fixed/stdio.h:222:7: error: conflicting declaration of 'char* ctermid(char*)' with 'C' linkage
    - osx_image: xcode11.2
  include:
    - osx_image: xcode10.3
    - osx_image: xcode11.2

install:
  - mkdir -p ${HOME}/vcpkg && pushd ${HOME}/vcpkg
  - | # build vcpkg
    git init
    git remote add origin https://github.com/Microsoft/vcpkg.git
    git fetch origin 2019.11
    git checkout FETCH_HEAD
    CC=gcc-9 CXX=g++-9 ./bootstrap-vcpkg.sh
  # install required packages
  - ./vcpkg install ms-gsl tbb grpc gtest
  - popd

script:
  - mkdir -p build && pushd build
  - cmake ..
    -DCMAKE_TOOLCHAIN_FILE="${HOME}/vcpkg/scripts/buildsystems/vcpkg.cmake"
  # codegen and build
  - cmake --build . --config debug
